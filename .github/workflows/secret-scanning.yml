name: Secret Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  security-events: write

jobs:
  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for thorough scanning

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  github-secret-scanning:
    name: GitHub Secret Scanning Alert
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for common secret patterns
        run: |
          echo "Checking for common secret patterns..."
          # Check for common patterns that might indicate secrets
          if grep -r -E "(api[_-]?key|secret[_-]?key|password|token|credential)" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.json" --include="*.env*" . | grep -v "node_modules" | grep -v ".git" | grep -v "dist" | grep -v "SECRET" | grep -v "API_KEY" | grep -v "example" | grep -v "placeholder" | grep -v "your_" | grep -v "dummy"; then
            echo "⚠️ Warning: Potential secret patterns found. Please review."
            echo "This is a basic check. Ensure no actual secrets are committed."
            exit 0  # Don't fail the build, just warn
          else
            echo "✅ No obvious secret patterns found."
          fi

